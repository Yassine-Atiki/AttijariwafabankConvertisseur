<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Convertisseur MX/MT - Attijariwafa bank</title>
    <link rel="stylesheet" href="/css/dashboard.css" />
    <style>
        /* CSS inline pour s'assurer que les vues fonctionnent */
        .view {
            display: none;
        }
        .view.is-visible {
            display: block;
        }
    </style>
</head>
<body>
<!-- Barre de navigation sup√©rieure -->
<nav class="top-navbar">
    <div class="user-profile">
        <div class="profile-icon" th:text="${username != null ? username.substring(0,1).toUpperCase() : 'U'}">A</div>
        <div class="profile-info">
            <div class="profile-name" th:text="${username != null ? username : 'Utilisateur'}">admin</div>
        </div>
        <div class="profile-actions">
            <form action="/logout" method="post" style="display: inline;">
                <button type="submit" class="logout-btn" aria-label="D√©connexion">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H3"/>
                    </svg>
                </button>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>
        </div>
    </div>
</nav>

<div class="app-shell">
    <aside class="sidebar" role="navigation" aria-label="Menu principal">
        <div class="sidebar-header">
            <img class="sidebar-logo" src="/images/attijari_logo.png" alt="Logo Attijariwafa bank" />
            <div class="brand-text">
                <span class="bank">Attijariwafa bank</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a id="nav-home" class="nav-item active" href="javascript:void(0)" onclick="showSection('view-home')" title="Accueil">
                <span class="label">Accueil</span>
            </a>
            <a id="nav-convert" class="nav-item" href="javascript:void(0)" onclick="showSection('view-convert')" title="Convertir">
                <span class="label">pain.001 ‚Üí MT101</span>
            </a>
            <a id="nav-transform" class="nav-item" href="javascript:void(0)" onclick="showSection('view-transform')" title="Historique">
                <span class="label">Historique</span>
            </a>
            <a id="nav-reports" class="nav-item" href="javascript:void(0)" onclick="showSection('view-reports')" title="Rapports">
                <span class="label">Rapports Erreurs</span>
            </a>
            <a id="nav-admin-users" class="nav-item" href="javascript:void(0)" th:if="${isAdmin}" onclick="showSection('view-admin-users')" title="Autres utilisateurs">
                <span class="label">Autres Utilisateurs</span>
            </a>
        </nav>
    </aside>

    <div class="content">
        <!-- Zone notifications admin -->
        <div id="admin-messages" style="position:fixed;top:70px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px;max-width:320px;"></div>

        <section id="view-home" class="view is-visible welcome" aria-label="Accueil">
            <div class="home-grid">
                <div class="home-main">
                    <div class="panel">
                        <div class="welcome-row">
                            <div>
                                <strong>Bienvenue dans le Convertisseur MX ‚Üí MT</strong>
                                <div class="muted" th:text="${username != null ? username : 'Utilisateur'}">admin</div>
                            </div>
                            <button class="btn btn-primary" type="button" onclick="showSection('view-convert')">Nouvelle transformation</button>
                        </div>
                    </div>

                    <!-- Section s√©lection utilisateur pour admin -->
                    <div th:if="${isAdmin}" class="panel" style="margin-bottom: 20px;">
                        <div class="panel-header">
                            <h2>S√©lection utilisateur (Admin)</h2>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center; padding: 15px;">
                            <label for="userSelector" style="font-weight: 500;">Voir les statistiques de :</label>
                            <select id="userSelector" class="form-select" onchange="loadUserStats(this.value)" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; min-width: 200px;">
                                <option value="">-- S√©lectionner un utilisateur --</option>
                                <option value="global">Vue globale (tous utilisateurs)</option>
                                <option th:each="user : ${allUsers}" th:value="${user}" th:text="${user}">Utilisateur</option>
                            </select>
                            <button class="btn btn-outline" onclick="refreshUserStats()" style="padding: 8px 12px;">üîÑ Actualiser</button>
                        </div>

                        <!-- Zone d'affichage des statistiques utilisateur -->
                        <div id="userStatsDisplay" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;">
                            <div class="user-stats-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 id="selectedUserTitle" style="margin: 0; color: #333;">Statistiques utilisateur</h3>
                                <div class="user-stats-badges" id="userStatsBadges"></div>
                            </div>

                            <!-- M√©triques utilisateur -->
                            <div class="user-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="metric-card user-metric">
                                    <div class="ring total" style="--v:.50"><div class="center">Œ£</div></div>
                                    <div>
                                        <div class="metric-title">Total Conversions</div>
                                        <div class="metric-value" id="userTotalCount">0</div>
                                    </div>
                                </div>
                                <div class="metric-card user-metric">
                                    <div class="ring success" style="--v:.70"><div class="center">‚úì</div></div>
                                    <div>
                                        <div class="metric-title">Conversions R√©ussies</div>
                                        <div class="metric-value" id="userValidCount">0</div>
                                    </div>
                                </div>
                                <div class="metric-card user-metric">
                                    <div class="ring error" style="--v:.20"><div class="center">!</div></div>
                                    <div>
                                        <div class="metric-title">Conversions √âchou√©es</div>
                                        <div class="metric-value" id="userErrorCount">0</div>
                                    </div>
                                </div>
                                <div class="metric-card user-metric">
                                    <div class="ring success" style="--v:.80"><div class="center">%</div></div>
                                    <div>
                                        <div class="metric-title">Taux de R√©ussite</div>
                                        <div class="metric-value" id="userSuccessRate">0%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Graphique utilisateur -->
                            <div class="user-chart-container chart" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; color: #555;">Graphique des conversions</h4>
                                <svg id="userChart" viewBox="0 0 420 240" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Graphique utilisateur"></svg>
                            </div>

                            <!-- Derni√®res conversions -->
                            <div class="user-recent-conversions" style="margin-top: 20px;">
                                <h4 style="color: #555; margin-bottom: 10px;">Derni√®res conversions</h4>
                                <div id="userRecentList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric-cards">
                            <div class="metric-card">
                                <div class="ring total" style="--v:.94"><div class="center">Œ£</div></div>
                                <div>
                                    <div class="metric-title">Total Messages</div>
                                    <div class="metric-value" id="totalCount" th:text="${totalConversions}">0</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="ring success" style="--v:.96"><div class="center">‚úì</div></div>
                                <div>
                                    <div class="metric-title">Messages Valides</div>
                                    <div class="metric-value" id="validCount" th:text="${validConversions}">0</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="ring error" style="--v:.04"><div class="center">!</div></div>
                                <div>
                                    <div class="metric-title">Messages en Erreur</div>
                                    <div class="metric-value" id="invalidCount" th:text="${invalidConversions}">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphique r√©capitulatif -->
                    <div class="panel chart" aria-label="Graphique d‚Äôensemble des messages">
                        <div class="panel-header">
                            <h2>Vue d‚Äôensemble</h2>
                        </div>
                        <svg id="homeChart" viewBox="0 0 420 240" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Barres: Total, Valides, Erreurs"></svg>
                    </div>
                </div>

                <!-- Colonne droite: Calendrier / filtre par date -->
                <aside class="calendar">
                    <div class="panel" aria-labelledby="dateFilterTitle">
                        <div class="cal-head">
                            <span id="dateFilterTitle" class="month">Filtrer par date</span>
                        </div>
                        <div class="calendar-widget" aria-label="Calendrier de s√©lection">
                            <div class="cw-header">
                                <button type="button" class="nav prev" id="cwPrev" aria-label="Mois pr√©c√©dent">‚Äπ</button>
                                <div class="cw-label" id="cwLabel">Mois Ann√©e</div>
                                <button type="button" class="nav next" id="cwNext" aria-label="Mois suivant">‚Ä∫</button>
                            </div>
                            <div class="cw-weekdays" aria-hidden="true">
                                <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
                            </div>
                            <div class="cw-grid" id="cwGrid" role="grid" aria-label="S√©lection de date"></div>
                            <div class="muted" id="dateInfo">Statistiques du jour</div>
                        </div>
                    </div>

                    <!-- Nouveau: Filtrer par plage de dates -->
                    <div class="panel" style="margin-top:12px;" aria-label="Filtrer par plage de dates">
                        <div class="cal-head">
                            <span class="month">Filtrer par plage</span>
                        </div>
                        <div style="padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:end;">
                            <div>
                                <label for="rangeFrom" style="display:block;font-size:12px;color:#555;margin-bottom:4px;">Du</label>
                                <input type="date" id="rangeFrom" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                            </div>
                            <div>
                                <label for="rangeTo" style="display:block;font-size:12px;color:#555;margin-bottom:4px;">Au</label>
                                <input type="date" id="rangeTo" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:6px;" />
                            </div>
                            <div style="grid-column: span 2; display:flex; gap:8px;">
                                <button class="btn btn-primary" type="button" onclick="applyRange()">Appliquer</button>
                                <button class="btn btn-outline" type="button" onclick="clearRange()">R√©initialiser</button>
                            </div>
                            <div id="rangeInfo" class="muted" style="grid-column: span 2;"></div>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <section id="view-convert" class="view" aria-label="Conversion pain.001 vers MT101">
            <div class="container">
                <h1>Convertisseur MX PAIN 001 ‚Üí MT 101</h1>

                <div class="panel">
                    <div class="panel-header">
                        <h2>Param√®tres de conversion</h2>
                    </div>
                    <div class="options-grid">
                        <div class="field" style="grid-column: span 6;">
                            <span>Type source</span>
                            <input type="text" value="MX PAIN 001 v3 (ISO 20022)" readonly />
                        </div>
                        <div class="field" style="grid-column: span 6;">
                            <span>Type cible</span>
                            <input type="text" value="MT 101 (SWIFT FIN)" readonly />
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2>Zone de conversion</h2>
                        <div class="panel-actions">
                            <label class="btn btn-secondary file-label">
                                Importer un XML
                                <input type="file" id="file-input" accept=".xml" onchange="loadFile(this)">
                            </label>
                            <button class="btn btn-outline" onclick="clearAll()">Vider</button>
                            <button class="btn btn-primary" onclick="convertMX()">Convertir</button>
                        </div>
                    </div>

                    <div class="dropzone">Glissez-d√©posez votre fichier ici ou utilisez ¬´ Importer un XML ¬ª</div>

                    <div class="grid io">
                        <div class="input">
                            <div class="panel-header">
                                <h2>Entr√©e MX PAIN 001</h2>
                            </div>
                            <textarea id="mx-input" rows="18" placeholder="Collez votre message MX PAIN 001 ici..."></textarea>
                        </div>
                        <div class="output">
                            <div class="panel-header">
                                <h2>Sortie MT 101</h2>
                                <div class="panel-actions">
                                    <button class="btn btn-outline" onclick="copyMT()">Copier</button>
                                    <button class="btn btn-secondary" onclick="downloadMT()">T√©l√©charger</button>
                                </div>
                            </div>
                            <textarea id="mt-output" rows="18" placeholder="Le message MT 101 appara√Ætra ici..." readonly></textarea>
                        </div>
                    </div>
                </div>

                <div class="panel validation">
                    <h3>Statut de validation</h3>
                    <div id="validation-status">
                        <!-- Rendu dynamique par updateValidationStatus() -->
                    </div>
                </div>
            </div>
        </section>

        <section id="view-transform" class="view" aria-label="Historique des Conversions">
            <div class="container">
                <h1>Historique des conversions</h1>
                <div class="panel">
                    <div class="panel-header">
                        <h2>Conversions MX ‚Üí MT101</h2>
                        <div th:if="${isAdmin}" class="panel-actions" style="display:flex;gap:8px;align-items:center;">
                            <button class="btn btn-outline" onclick="deleteOwnHistory()">üóë Supprimer mon historique</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Format</th>
                                    <th>Statut</th>
                                    <th>T√©l√©charger MT101</th>
                                    <th th:if="${isAdmin}">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="history : ${conversionHistoryPaginated}">
                                    <td th:text="${#temporals.format(history.conversionDate, 'dd/MM/yyyy HH:mm')}">-</td>
                                    <td th:text="${history.inputFormat + ' ‚Üí ' + history.outputFormat}">-</td>
                                    <td>
                                        <span class="chip" th:classappend="${history.status == 'SUCCESS' or history.status == 'VALID' ? ' ok' : ' warn'}" th:text="${history.status}">-</span>
                                    </td>
                                    <td>
                                        <a class="btn btn-outline" th:if="${history.mtContent != null and (history.status == 'SUCCESS' or history.status == 'VALID')}" th:href="@{/api/conversion/history/{id}/download(id=${history.id})}" target="_blank">T√©l√©charger</a>
                                        <span th:if="${history.mtContent == null or (history.status != 'SUCCESS' and history.status != 'VALID')}" class="muted">Indisponible</span>
                                    </td>
                                    <td th:if="${isAdmin}">
                                        <div style="display: flex; gap: 4px; align-items: center;">
                                            <button class="btn btn-outline"
                                                    style="color:#b91c1c; border-color:#b91c1c; padding: 4px 8px; font-size: 12px;"
                                                    th:attr="data-id=${history.id}"
                                                    onclick="deleteEntry(this.getAttribute('data-id'), this)"
                                                    title="Supprimer cette entr√©e">
                                                üóë
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(conversionHistoryPaginated)}">
                                    <td th:colspan="${isAdmin ? 5 : 4}" style="padding: 20px; text-align: center; font-style: italic;">Aucun historique disponible</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination pour l'historique personnel -->
                    <div th:if="${totalHistoryPages > 1}" class="pagination-wrapper" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                        <button th:if="${hasPrevHistory}"
                                class="btn btn-outline"
                                th:onclick="'navigateToHistoryPage(' + ${currentHistoryPage - 1} + ')'"
                                style="padding: 8px 12px;">
                            ‚Üê Pr√©c√©dent
                        </button>

                        <!-- Num√©ros de pages cliquables -->
                        <div class="page-numbers" style="display: flex; gap: 5px; align-items: center;">
                            <!-- Premi√®re page si pas visible -->
                            <button th:if="${currentHistoryPage > 2}"
                                    class="btn btn-outline"
                                    th:onclick="'navigateToHistoryPage(0)'"
                                    style="padding: 6px 10px; font-size: 14px;">
                                1
                            </button>

                            <!-- Points de suspension -->
                            <span th:if="${currentHistoryPage > 3}" style="color: #666; padding: 0 5px;">...</span>

                            <!-- Pages autour de la page actuelle -->
                            <th:block th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, currentHistoryPage - 2), T(java.lang.Math).min(totalHistoryPages - 1, currentHistoryPage + 2))}">
                                <button th:if="${pageNum == currentHistoryPage}"
                                        class="btn btn-primary"
                                        style="padding: 6px 10px; font-size: 14px; cursor: default;"
                                        disabled>
                                    <span th:text="${pageNum + 1}">1</span>
                                </button>
                                <button th:if="${pageNum != currentHistoryPage}"
                                        class="btn btn-outline"
                                        th:onclick="'navigateToHistoryPage(' + ${pageNum} + ')'"
                                        style="padding: 6px 10px; font-size: 14px;">
                                    <span th:text="${pageNum + 1}">1</span>
                                </button>
                            </th:block>

                            <!-- Points de suspension -->
                            <span th:if="${currentHistoryPage < totalHistoryPages - 4}" style="color: #666; padding: 0 5px;">...</span>

                            <!-- Derni√®re page si pas visible -->
                            <button th:if="${currentHistoryPage < totalHistoryPages - 3}"
                                    class="btn btn-outline"
                                    th:onclick="'navigateToHistoryPage(' + ${totalHistoryPages - 1} + ')'"
                                    style="padding: 6px 10px; font-size: 14px;">
                                <span th:text="${totalHistoryPages}">1</span>
                            </button>
                        </div>

                        <span style="font-size: 14px; color: #666; margin: 0 10px;">
                            (<span th:text="${totalHistoryElements}">0</span> √©l√©ments)
                        </span>

                        <button th:if="${hasNextHistory}"
                                class="btn btn-outline"
                                th:onclick="'navigateToHistoryPage(' + ${currentHistoryPage + 1} + ')'"
                                style="padding: 8px 12px;">
                            Suivant ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-reports" class="view" aria-label="Rapports et Logs">
            <div class="container">
                <h1>Rapports & Logs</h1>
                <div class="panel validation">
                    <div class="panel-header">
                        <h2>Conversions en √©chec</h2>
                    </div>

                    <div th:if="${#lists.isEmpty(failedConversionsList)}" style="padding: 12px; color: #6b7280; font-style: italic;">
                        Aucune conversion en √©chec.
                    </div>

                    <div th:each="item : ${failedConversionsList}" class="validation-card error" style="margin-bottom: 10px;">
                        <div class="header">
                            <div class="state error">
                                <span class="state-icon">‚úï</span>
                                <span class="state-text">
                                    <span th:text="${#temporals.format(item.conversionDate, 'dd/MM/yyyy HH:mm')}">--/--/---- --:--</span>
                                    ‚Äî
                                    <span th:text="${item.errorMessage != null ? item.errorMessage : 'Erreur de conversion'}">Erreur</span>
                                </span>
                            </div>
                            <div class="muted" style="font-size:12px;" th:text="${item.inputFormat + ' ‚Üí ' + item.outputFormat}">pain.001 ‚Üí MT101</div>
                        </div>

                        <div class="details" th:if="${(item.mxValidationErrors != null and !item.mxValidationErrors.isEmpty()) or (item.mtValidationErrors != null and !item.mtValidationErrors.isEmpty())}">
                            <div class="details-title">D√©tails de validation</div>
                            <ul class="details-list">
                                <li class="detail error-item" th:each="err : ${item.mxValidationErrors}" th:text="${err}">Erreur MX</li>
                                <li class="detail error-item" th:each="err : ${item.mtValidationErrors}" th:text="${err}">Erreur MT</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-admin-users" class="view" th:if="${isAdmin}" aria-label="Historique autres utilisateurs">
            <div class="container">
                <h1>Historique des autres utilisateurs</h1>
                <div class="panel">
                    <div class="panel-header">
                        <h2>Conversions des autres comptes</h2>
                        <div class="panel-actions" style="display:flex;gap:6px;align-items:center;">
                            <input type="text" id="usernameToDelete" placeholder="Utilisateur..." style="padding:6px;border:1px solid #ccc;border-radius:4px;" />
                            <button class="btn btn-outline" onclick="deleteUserHistory(null, this)">üóë Supprimer utilisateur</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Utilisateur</th>
                                    <th>Format</th>
                                    <th>Statut</th>
                                    <th>T√©l√©charger MT101</th>
                                    <th th:if="${isAdmin}">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="h : ${otherUsersHistory}">
                                    <td th:text="${#temporals.format(h.conversionDate, 'dd/MM/yyyy HH:mm')}">-</td>
                                    <td th:text="${h.ownerUsername}">user</td>
                                    <td th:text="${h.inputFormat + ' ‚Üí ' + h.outputFormat}">-</td>
                                    <td><span class="chip" th:classappend="${h.status=='SUCCESS' ? ' ok':' warn'}" th:text="${h.status}">STATUS</span></td>
                                    <td>
                                        <a class="btn btn-outline" th:if="${h.mtContent != null and h.status=='SUCCESS'}" th:href="@{/api/conversion/history/{id}/download(id=${h.id})}" target="_blank">T√©l√©charger</a>
                                        <span th:if="${h.mtContent == null or h.status!='SUCCESS'}" class="muted">Indisponible</span>
                                    </td>
                                    <td th:if="${isAdmin}">
                                        <button class="btn btn-outline" style="color:#b91c1c;border-color:#b91c1c" th:attr="data-id=${h.id}" onclick="deleteEntry(this.getAttribute('data-id'), this)">üóë</button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(otherUsersHistory)}">
                                    <td colspan="6" style="padding:18px;text-align:center;font-style:italic;">Aucune conversion d'autres utilisateurs</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination pour les autres utilisateurs -->
                    <div th:if="${totalOtherUsersPages > 1}" class="pagination-wrapper" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                        <button th:if="${hasPrevOtherUsers}"
                                class="btn btn-outline"
                                th:onclick="'navigateToOtherUsersPage(' + ${currentOtherUsersPage - 1} + ')'"
                                style="padding: 8px 12px;">
                            ‚Üê Pr√©c√©dent
                        </button>

                        <!-- Num√©ros de pages cliquables -->
                        <div class="page-numbers" style="display: flex; gap: 5px; align-items: center;">
                            <!-- Premi√®re page si pas visible -->
                            <button th:if="${currentOtherUsersPage > 2}"
                                    class="btn btn-outline"
                                    th:onclick="'navigateToOtherUsersPage(0)'"
                                    style="padding: 6px 10px; font-size: 14px;">
                                1
                            </button>

                            <!-- Points de suspension -->
                            <span th:if="${currentOtherUsersPage > 3}" style="color: #666; padding: 0 5px;">...</span>

                            <!-- Pages autour de la page actuelle -->
                            <th:block th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, currentOtherUsersPage - 2), T(java.lang.Math).min(totalOtherUsersPages - 1, currentOtherUsersPage + 2))}">
                                <button th:if="${pageNum == currentOtherUsersPage}"
                                        class="btn btn-primary"
                                        style="padding: 6px 10px; font-size: 14px; cursor: default;"
                                        disabled>
                                    <span th:text="${pageNum + 1}">1</span>
                                </button>
                                <button th:if="${pageNum != currentOtherUsersPage}"
                                        class="btn btn-outline"
                                        th:onclick="'navigateToOtherUsersPage(' + ${pageNum} + ')'"
                                        style="padding: 6px 10px; font-size: 14px;">
                                    <span th:text="${pageNum + 1}">1</span>
                                </button>
                            </th:block>

                            <!-- Points de suspension -->
                            <span th:if="${currentOtherUsersPage < totalOtherUsersPages - 4}" style="color: #666; padding: 0 5px;">...</span>

                            <!-- Derni√®re page si pas visible -->
                            <button th:if="${currentOtherUsersPage < totalOtherUsersPages - 3}"
                                    class="btn btn-outline"
                                    th:onclick="'navigateToOtherUsersPage(' + ${totalOtherUsersPages - 1} + ')'"
                                    style="padding: 6px 10px; font-size: 14px;">
                                <span th:text="${totalOtherUsersPages}">1</span>
                            </button>
                        </div>

                        <span style="font-size: 14px; color: #666; margin: 0 10px;">
                            (<span th:text="${totalOtherUsersElements}">0</span> √©l√©ments)
                        </span>

                        <button th:if="${hasNextOtherUsers}"
                                class="btn btn-outline"
                                th:onclick="'navigateToOtherUsersPage(' + ${currentOtherUsersPage + 1} + ')'"
                                style="padding: 8px 12px;">
                            Suivant ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
// Navigation entre les sections
function showSection(sectionId, pushState = true) {
    console.log('Navigation vers: ' + sectionId);

    // Masquer toutes les vues
    const views = document.querySelectorAll('.view');
    views.forEach(view => {
        view.classList.remove('is-visible');
    });

    // D√©sactiver tous les √©l√©ments de navigation
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });

    // Afficher la section demand√©e
    const targetView = document.getElementById(sectionId);
    if (targetView) {
        targetView.classList.add('is-visible');
    }

    // Activer l'√©l√©ment de navigation correspondant
    const navId = sectionId.replace('view-', 'nav-');
    const activeNav = document.getElementById(navId);
    if (activeNav) {
        activeNav.classList.add('active');
    }

    // Persistance (√©viter retour Accueil apr√®s reload)
    try {
        localStorage.setItem('activeSection', sectionId);
        if (pushState) {
            // Utiliser hash pour permettre navigation via favoris / retour
            if (window.location.hash !== '#' + sectionId) {
                history.replaceState(null, '', '#' + sectionId);
            }
        }
    } catch(e) { /* stockage non critique */ }
}

// Charger un fichier
function loadFile(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('mx-input').value = e.target.result;
            updateValidationStatus('üìÑ Fichier charg√©: ' + file.name);
        };
        reader.readAsText(file);
    }
}

// Conversion MX vers MT101
async function convertMX() {
    const mxContent = document.getElementById('mx-input').value;
    const outputArea = document.getElementById('mt-output');

    if (!mxContent.trim()) {
        updateValidationStatus('‚ùå Veuillez entrer un message MX PAIN 001');
        return;
    }

    updateValidationStatus('üîÑ Conversion en cours...');

    try {
        const response = await fetch('/api/conversion/convert/text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/xml; charset=utf-8'
            },
            body: mxContent
        });

        const result = await response.json();

        if (result.success) {
            outputArea.value = result.mtMessage;
            updateValidationStatus('‚úÖ Conversion MT101 r√©ussie', result.validationErrors);
        } else {
            outputArea.value = '';
            updateValidationStatus('‚ùå Erreur: ' + result.errorMessage, result.validationErrors);
        }

    } catch (error) {
        console.error('Erreur de conversion:', error);
        updateValidationStatus('‚ùå Erreur de communication: ' + error.message);
        outputArea.value = '';
    }
}

// Helpers statut
function getStatusType(message) {
    const m = (message || '').toLowerCase();
    if (m.includes('‚ùå') || m.includes('erreur')) return 'error';
    if (m.includes('‚úÖ') || m.includes('r√©uss') || m.includes('succ√®s')) return 'ok';
    if (m.includes('‚ö†') || m.includes('avert') || m.includes('warn')) return 'warn';
    return 'info';
}
function stripLeadingEmoji(text) {
    return (text || '').replace(/^([\p{Emoji_Presentation}\p{Emoji}\u200d\ufe0f\s]+)/u, '').trim() || text;
}
function statusIcon(type) {
    switch(type){
        case 'ok': return '‚úì';
        case 'warn': return '‚ö†';
        case 'error': return '‚úï';
        default: return '‚Ñπ';
    }
}

// Mettre √† jour le statut de validation (version am√©lior√©e)
function updateValidationStatus(message, validationErrors = null) {
    const statusDiv = document.getElementById('validation-status');
    const type = getStatusType(message);
    const cleanMessage = stripLeadingEmoji(message);

    let detailsHtml = '';
    if (validationErrors && validationErrors.length > 0) {
        const items = validationErrors
            .map(err => `<li class="detail error-item">${err}</li>`) // erreurs en rouge
            .join('');
        detailsHtml = `
            <div class="details">
                <div class="details-title">D√©tails de validation</div>
                <ul class="details-list">${items}</ul>
            </div>`;
    }

    statusDiv.innerHTML = `
        <div class="validation-card ${type}">
            <div class="header">
                <div class="state ${type}">
                    <span class="state-icon">${statusIcon(type)}</span>
                    <span class="state-text">${cleanMessage}</span>
                </div>
            </div>
            ${detailsHtml}
        </div>
    `;
}

// Vider les zones de texte
function clearAll() {
    document.getElementById('mx-input').value = '';
    document.getElementById('mt-output').value = '';
    const input = document.getElementById('file-input');
    if (input) input.value = '';
    updateValidationStatus('‚ÑπÔ∏è Pr√™t pour la conversion');
}

// Copier le message MT101
function copyMT() {
    const mtOutput = document.getElementById('mt-output');
    if (mtOutput.value.trim()) {
        mtOutput.select();
        document.execCommand('copy');
        updateValidationStatus('üìã Message MT101 copi√© dans le presse-papier');
    } else {
        updateValidationStatus('‚ùå Aucun message MT101 √† copier');
    }
}

// T√©l√©charger le message MT101
function downloadMT() {
    const mtOutput = document.getElementById('mt-output');
    if (mtOutput.value.trim()) {
        const blob = new Blob([mtOutput.value], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'message_MT101_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        updateValidationStatus('üíæ Message MT101 t√©l√©charg√©');
    } else {
        updateValidationStatus('‚ùå Aucun message MT101 √† t√©l√©charger');
    }
}

// Afficher les d√©tails d'un historique
function viewDetails() {
    alert('Fonctionnalit√© en d√©veloppement');
}

// Dessiner un bar chart simple dans un SVG
function renderHomeChart() {
    const total = parseInt((document.getElementById('totalCount')||{}).innerText || '0', 10);
    const valids = parseInt((document.getElementById('validCount')||{}).innerText || '0', 10);
    const errors = parseInt((document.getElementById('invalidCount')||{}).innerText || '0', 10);

    const svg = document.getElementById('homeChart');
    if (!svg) return;

    const width = 420; const height = 240; const pad = {l:48, r:16, t:16, b:40};
    const chartW = width - pad.l - pad.r; const chartH = height - pad.t - pad.b;

    const data = [
        { label: 'Total', value: total, color: getComputedStyle(document.documentElement).getPropertyValue('--awb-orange') || '#f08a00' },
        { label: 'Valides', value: valids, color: '#16a34a' },
        { label: 'Erreurs', value: errors, color: getComputedStyle(document.documentElement).getPropertyValue('--awb-red') || '#e03c31' }
    ];

    const max = Math.max(1, ...data.map(d => d.value));
    const barW = Math.min(80, Math.floor(chartW / (data.length * 2)));
    const gap = Math.floor((chartW - data.length * barW) / (data.length + 1));

    // Reset
    svg.innerHTML = '';

    // Axes (Y grid)
    const steps = 4;
    for (let i=0; i<=steps; i++) {
        const y = pad.t + chartH - (i/steps) * chartH;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', pad.l);
        line.setAttribute('x2', pad.l + chartW);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#e5e7eb');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);

        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', pad.l - 6);
        label.setAttribute('y', y + 4);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('font-size', '11');
        label.setAttribute('fill', '#6b7280');
        label.textContent = Math.round((i/steps) * max);
        svg.appendChild(label);
    }

    // Bars + labels
    data.forEach((d, idx) => {
        const x = pad.l + gap + idx * (barW + gap);
        const h = d.value === 0 ? 0 : Math.round((d.value / max) * chartH);
        const y = pad.t + chartH - h;

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barW);
        rect.setAttribute('height', h);
        rect.setAttribute('rx', 6);
        rect.setAttribute('fill', d.color.trim());
        rect.setAttribute('opacity', '0.9');
        svg.appendChild(rect);

        // Value label
        const val = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        val.setAttribute('x', x + barW/2);
        val.setAttribute('y', y - 6);
        val.setAttribute('text-anchor', 'middle');
        val.setAttribute('font-size', '12');
        val.setAttribute('fill', '#111827');
        val.textContent = d.value;
        svg.appendChild(val);

        // Category label
        const lab = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        lab.setAttribute('x', x + barW/2);
        lab.setAttribute('y', pad.t + chartH + 18);
        lab.setAttribute('text-anchor', 'middle');
        lab.setAttribute('font-size', '12');
        lab.setAttribute('fill', '#374151');
        lab.textContent = d.label;
        svg.appendChild(lab);
    });
}

// ---- Filtre par date (stats + graphe) ----
function todayStr() {
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
}

// Utils date (ISO <-> Date)
function pad2(n){return String(n).padStart(2,'0');}
function toISODateStr(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}

// Chargement des stats pour une date ISO (YYYY-MM-DD)
async function loadStatsForDate(dateStr) {
    try {
        const res = await fetch(`/api/stats/by-date?date=${dateStr}`);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const totalEl = document.getElementById('totalCount');
        const validEl = document.getElementById('validCount');
        const invalidEl = document.getElementById('invalidCount');
        if (totalEl) totalEl.innerText = data.total ?? 0;
        if (validEl) validEl.innerText = data.valid ?? 0;
        if (invalidEl) invalidEl.innerText = data.error ?? 0;
        const info = document.getElementById('dateInfo');
        if (info) info.innerText = `Statistiques du ${dateStr}`;
        renderHomeChart();
    } catch (e) {
        console.error('Erreur stats by date:', e);
    }
}

// Charger les stats pour une plage de dates [from, to]
async function loadStatsForRange(fromStr, toStr){
    try {
        const res = await fetch(`/api/stats/by-range?from=${encodeURIComponent(fromStr)}&to=${encodeURIComponent(toStr)}`);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const totalEl = document.getElementById('totalCount');
        const validEl = document.getElementById('validCount');
        const invalidEl = document.getElementById('invalidCount');
        if (totalEl) totalEl.innerText = data.total ?? 0;
        if (validEl) validEl.innerText = data.valid ?? 0;
        if (invalidEl) invalidEl.innerText = data.error ?? 0;
        const info = document.getElementById('dateInfo');
        if (info) info.innerText = `Statistiques du ${fromStr} au ${toStr}`;
        const rinfo = document.getElementById('rangeInfo');
        if (rinfo) rinfo.innerText = `Plage appliqu√©e: ${fromStr} ‚Üí ${toStr}`;
        renderHomeChart();
    } catch (e) {
        console.error('Erreur stats by-range:', e);
        pushMessage('error', 'Erreur lors du chargement des statistiques de plage: ' + e.message);
    }
}

function applyRange(){
    const fromEl = document.getElementById('rangeFrom');
    const toEl = document.getElementById('rangeTo');
    const from = fromEl?.value;
    const to = toEl?.value;
    if (!from || !to) { pushMessage('warn','Veuillez s√©lectionner une plage (Du/Au).'); return; }
    if (to < from) {
        // inverser si n√©cessaire, c√¥t√© UI
        loadStatsForRange(to, from);
    } else {
        loadStatsForRange(from, to);
    }
}

function clearRange(){
    const fromEl = document.getElementById('rangeFrom');
    const toEl = document.getElementById('rangeTo');
    if (fromEl) fromEl.value = '';
    if (toEl) toEl.value = '';
    const rinfo = document.getElementById('rangeInfo');
    if (rinfo) rinfo.innerText = '';
    // Revenir sur la date du jour
    const t = todayStr();
    loadStatsForDate(t);
}

// Calendrier moderne int√©gr√© (toujours visible)
let cwCurrent = new Date(); // mois affich√© (1er du mois)
let cwSelected = null;      // date s√©lectionn√©e

function buildCwDayCell(label, cls, dateObj){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'cw-day ' + (cls||'');
    btn.textContent = label;
    if (dateObj) {
        const iso = toISODateStr(dateObj);
        btn.setAttribute('aria-label', iso);
        btn.addEventListener('click', ()=>{
            cwSelected = dateObj;
            renderCalendarWidget();
            loadStatsForDate(iso);
        });
    } else {
        btn.disabled = true;
        btn.setAttribute('aria-disabled','true');
    }
    return btn;
}

function renderCalendarWidget(){
    const label = document.getElementById('cwLabel');
    const grid = document.getElementById('cwGrid');
    if(!label || !grid) return;

    // Titre mois/ann√©e
    const monthName = cwCurrent.toLocaleString('fr-FR', { month: 'long' });
    label.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1) + ' ' + cwCurrent.getFullYear();

    // Grille 7√ó6
    grid.innerHTML = '';
    const first = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth(), 1);
    const startDay = (first.getDay() || 7); // Lundi=1 .. Dimanche=7
    const daysInMonth = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth()+1, 0).getDate();
    const prevDaysToShow = startDay - 1; // 0..6
    const prevMonthLast = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth(), 0).getDate();
    const afterDaysToShow = 42 - (prevDaysToShow + daysInMonth);

    const today = new Date();
    const sameMonthAsToday = (today.getFullYear()===cwCurrent.getFullYear() && today.getMonth()===cwCurrent.getMonth());

    // Jours du mois pr√©c√©dent
    for(let i=prevDaysToShow; i>0; i--){
        grid.appendChild(buildCwDayCell(prevMonthLast - i + 1, 'muted', null));
    }
    // Jours du mois courant
    for(let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth(), d);
        const isSelected = cwSelected && toISODateStr(dateObj) === toISODateStr(cwSelected);
        const isToday = sameMonthAsToday && d === today.getDate();
        let cls = 'current';
        if (isSelected) cls = 'selected';
        else if (isToday) cls = 'today';
        grid.appendChild(buildCwDayCell(d, cls, dateObj));
    }
    // Jours du mois suivant (compl√©ter √† 42)
    for(let i=1; i<=afterDaysToShow; i++){
        grid.appendChild(buildCwDayCell(i, 'muted', null));
    }
}

function cwPrevMonth(){ cwCurrent = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth()-1, 1); renderCalendarWidget(); }
function cwNextMonth(){ cwCurrent = new Date(cwCurrent.getFullYear(), cwCurrent.getMonth()+1, 1); renderCalendarWidget(); }

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard initialis√©');
    updateValidationStatus('‚ÑπÔ∏è Pr√™t pour la conversion');

    // Restaurer la derni√®re section choisie (hash > localStorage > accueil)
    let initialSection = null;
    if (window.location.hash && document.getElementById(window.location.hash.substring(1))) {
        initialSection = window.location.hash.substring(1);
    } else {
        const stored = localStorage.getItem('activeSection');
        if (stored && document.getElementById(stored)) {
            initialSection = stored;
        }
    }
    if (!initialSection) initialSection = 'view-home';
    showSection(initialSection, false);

    // Dessiner le graphique d'accueil
    renderHomeChart();

    // Init date picker √† aujourd'hui et charger stats du jour
    const input = document.getElementById('statsDate');
    if (input) {
        const t = todayStr();
        input.value = t;
        input.max = t;
        loadStatsForDate(t);
    }

    // Init calendrier moderne (toujours visible)
    const now = new Date();
    cwCurrent = new Date(now.getFullYear(), now.getMonth(), 1);
    cwSelected = now;

    const prev = document.getElementById('cwPrev');
    const next = document.getElementById('cwNext');
    if(prev) prev.addEventListener('click', cwPrevMonth);
    if(next) next.addEventListener('click', cwNextMonth);

    renderCalendarWidget();
    loadStatsForDate(toISODateStr(now));

    // Limiter les dates max des inputs de plage √† aujourd'hui
    const max = todayStr();
    const rf = document.getElementById('rangeFrom');
    const rt = document.getElementById('rangeTo');
    if (rf) rf.max = max;
    if (rt) rt.max = max;
});
function pushMessage(type, text){
  const box = document.getElementById('admin-messages');
  if(!box) return;
  const id = 'msg_'+Date.now();
  const colors = {success:'#16a34a', error:'#dc2626', info:'#2563eb', warn:'#d97706'};
  const el = document.createElement('div');
  el.id = id;
  el.style.cssText = 'background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.12);border-left:5px solid '+(colors[type]||'#2563eb')+';padding:10px 12px;font:14px system-ui;border-radius:6px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start;';
  el.innerHTML = `<span style="line-height:1.4">${text}</span><button aria-label="Fermer" style="background:none;border:0;color:#6b7280;cursor:pointer;font-size:16px;padding:0 4px;" onclick="this.parentElement.remove()">√ó</button>`;
  box.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, 4500);
}

function prepareConfirm(btn, originalLabel){
  btn.dataset.state = 'confirm';
  btn.textContent = 'Confirmer ?';
  btn.classList.add('warn');
  btn.style.backgroundColor = '#fcd34d';
  btn.style.color = '#000';
  if(btn._revertTimer) clearTimeout(btn._revertTimer);
  btn._revertTimer = setTimeout(()=>{
      btn.dataset.state='';
      btn.textContent = originalLabel;
      btn.classList.remove('warn');
      btn.style.backgroundColor='';
      btn.style.color='';
  }, 4000);
}

function finalizeButton(btn, label){
  if(btn){
    btn.dataset.state='';
    btn.textContent=label;
    btn.classList.remove('warn');
    btn.style.backgroundColor='';
    btn.style.color='';
  }
}

function deleteOwnHistory(btn){
  const button = btn || document.querySelector('button[onclick^="deleteOwnHistory"]');
  if(!button) return;
  const originalLabel = 'üóë Supprimer mon historique';
  if(button.dataset.state !== 'confirm'){
     prepareConfirm(button, originalLabel);
     pushMessage('info','Cliquez √† nouveau pour confirmer la suppression de votre historique.');
     return;
  }
  button.disabled = true; button.textContent='Suppression...';
  fetch('/api/admin/history/self', { method:'DELETE' })
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
    .then(msg=>{ pushMessage('success', msg); finalizeButton(button, originalLabel); button.disabled=false; setTimeout(()=>location.reload(),800); })
    .catch(e=>{ pushMessage('error','√âchec suppression: '+e.message); finalizeButton(button, originalLabel); button.disabled=false; });
}

function deleteUserHistory(username, btn){
  const input = document.getElementById('usernameToDelete');
  const user = username || (input ? input.value.trim(): '');
  const button = btn || (username? null : document.querySelector('button[onclick="deleteUserHistory()"]'));
  if(!user){ pushMessage('warn','Veuillez saisir un nom utilisateur.'); return; }
  if(button && button.dataset.state !== 'confirm'){
     prepareConfirm(button, 'üóë Supprimer utilisateur');
     pushMessage('info','Re-cliquez pour confirmer suppression de '+user+'.');
     button.dataset.pendingUser=user;
     return;
  }
  const targetUser = (button && button.dataset.pendingUser) ? button.dataset.pendingUser : user;
  if(button){ button.disabled=true; button.textContent='Suppression...'; }
  fetch('/api/admin/history/user/' + encodeURIComponent(targetUser), { method:'DELETE' })
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
    .then(msg=>{ pushMessage('success', msg); if(button){ finalizeButton(button,'üóë Supprimer utilisateur'); button.disabled=false; button.dataset.pendingUser=''; } setTimeout(()=>location.reload(),900); })
    .catch(e=>{ pushMessage('error','√âchec suppression: '+e.message); if(button){ finalizeButton(button,'üóë Supprimer utilisateur'); button.disabled=false; } });
}

function deleteEntry(id, btn){
  if(!id){ pushMessage('error','Id manquant'); return; }
  const button = btn;
  if(button && button.dataset.state !== 'confirm'){
     prepareConfirm(button,'üóë');
     pushMessage('info','Re-cliquez pour confirmer la suppression de cette entr√©e.');
     return;
  }
  if(button){ button.disabled=true; button.textContent='‚Ä¶'; }
  fetch('/api/admin/history/entry/' + encodeURIComponent(id), { method:'DELETE' })
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
    .then(msg=>{ pushMessage('success', msg); setTimeout(()=>location.reload(),700); })
    .catch(e=>{ pushMessage('error','Suppression impossible: '+e.message); if(button){ finalizeButton(button,'üóë'); button.disabled=false; }});
}

// Fonctions de navigation pour la pagination
function navigateToHistoryPage(pageNumber) {
    const currentParams = new URLSearchParams(window.location.search);
    currentParams.set('historyPage', pageNumber);
    window.location.href = '?' + currentParams.toString();
}

function navigateToOtherUsersPage(pageNumber) {
    const currentParams = new URLSearchParams(window.location.search);
    currentParams.set('otherUsersPage', pageNumber);
    window.location.href = '?' + currentParams.toString();
}

// ========== NOUVELLES FONCTIONS POUR STATISTIQUES UTILISATEUR ==========

let currentSelectedUser = null;
let userStatsDate = null;

// Charger les statistiques d'un utilisateur
async function loadUserStats(username) {
    const userStatsDisplay = document.getElementById('userStatsDisplay');
    const selectedUserTitle = document.getElementById('selectedUserTitle');

    if (!username) {
        userStatsDisplay.style.display = 'none';
        currentSelectedUser = null;
        return;
    }

    currentSelectedUser = username;
    userStatsDisplay.style.display = 'block';

    if (username === 'global') {
        selectedUserTitle.textContent = 'üìä Statistiques globales (tous utilisateurs)';
        loadGlobalStats();
        return;
    }

    selectedUserTitle.textContent = `üë§ Statistiques de ${username}`;

    try {
        // Charger les statistiques g√©n√©rales de l'utilisateur
        const response = await fetch(`/api/admin/users/${encodeURIComponent(username)}/stats`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const stats = await response.json();

        // Mettre √† jour les m√©triques
        updateUserMetrics(stats);

        // Dessiner le graphique utilisateur
        renderUserChart(stats);

        // Afficher les derni√®res conversions
        displayUserRecentConversions(stats.recentConversions || []);

        // Cr√©er les badges de statut
        updateUserBadges(stats);

        // Si une date est s√©lectionn√©e dans le calendrier, charger les stats de cette date
        if (userStatsDate) {
            loadUserStatsByDate(username, userStatsDate);
        }

    } catch (error) {
        console.error('Erreur lors du chargement des statistiques utilisateur:', error);
        selectedUserTitle.textContent = '‚ùå Erreur lors du chargement';
        updateUserMetrics({ totalConversions: 0, successfulConversions: 0, failedConversions: 0, successRate: 0 });
    }
}

// Charger les statistiques globales
function loadGlobalStats() {
    const totalEl = document.getElementById('totalCount');
    const validEl = document.getElementById('validCount');
    const invalidEl = document.getElementById('invalidCount');

    const total = parseInt(totalEl?.textContent || '0');
    const valid = parseInt(validEl?.textContent || '0');
    const invalid = parseInt(invalidEl?.textContent || '0');

    const globalStats = {
        username: 'global',
        totalConversions: total,
        successfulConversions: valid,
        failedConversions: invalid,
        successRate: total > 0 ? (valid / total * 100) : 0,
        recentConversions: []
    };

    updateUserMetrics(globalStats);
    renderUserChart(globalStats);
    displayUserRecentConversions([]);
    updateUserBadges(globalStats);
}

// Mettre √† jour les m√©triques utilisateur
function updateUserMetrics(stats) {
    document.getElementById('userTotalCount').textContent = stats.totalConversions || 0;
    document.getElementById('userValidCount').textContent = stats.successfulConversions || 0;
    document.getElementById('userErrorCount').textContent = stats.failedConversions || 0;
    document.getElementById('userSuccessRate').textContent = Math.round(stats.successRate || 0) + '%';

    // Mettre √† jour les anneaux de progression
    updateUserProgressRings(stats);
}

// Mettre √† jour les anneaux de progression
function updateUserProgressRings(stats) {
    const total = stats.totalConversions || 0;
    const valid = stats.successfulConversions || 0;
    const error = stats.failedConversions || 0;

    // Calculer les pourcentages pour les anneaux
    const maxValue = Math.max(total, 100); // Au moins 100 pour avoir une base
    const totalPercent = total / maxValue;
    const validPercent = valid / maxValue;
    const errorPercent = error / maxValue;
    const successRatePercent = (stats.successRate || 0) / 100;

    // Mettre √† jour les variables CSS
    document.querySelector('.user-metric .ring.total').style.setProperty('--v', totalPercent);
    document.querySelector('.user-metric .ring.success').style.setProperty('--v', validPercent);
    document.querySelector('.user-metric .ring.error').style.setProperty('--v', errorPercent);
    document.querySelectorAll('.user-metric .ring.success')[1]?.style.setProperty('--v', successRatePercent);
}

// Dessiner le graphique utilisateur
function renderUserChart(stats) {
    const svg = document.getElementById('userChart');
    if (!svg) return;

    const width = 420; const height = 240; const pad = {l:48, r:16, t:16, b:40};
    const chartW = width - pad.l - pad.r; const chartH = height - pad.t - pad.b;

    const data = [
        { label: 'Total', value: stats.totalConversions || 0, color: '#f08a00' },
        { label: 'R√©ussies', value: stats.successfulConversions || 0, color: '#16a34a' },
        { label: '√âchou√©es', value: stats.failedConversions || 0, color: '#e03c31' }
    ];

    const max = Math.max(1, ...data.map(d => d.value));
    const barW = Math.min(80, Math.floor(chartW / (data.length * 2)));
    const gap = Math.floor((chartW - data.length * barW) / (data.length + 1));

    // Reset
    svg.innerHTML = '';

    // Axes (Y grid)
    const steps = 4;
    for (let i=0; i<=steps; i++) {
        const y = pad.t + chartH - (i/steps) * chartH;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', pad.l);
        line.setAttribute('x2', pad.l + chartW);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#e5e7eb');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);

        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', pad.l - 6);
        label.setAttribute('y', y + 4);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('font-size', '11');
        label.setAttribute('fill', '#6b7280');
        label.textContent = Math.round((i/steps) * max);
        svg.appendChild(label);
    }

    // Bars + labels
    data.forEach((d, idx) => {
        const x = pad.l + gap + idx * (barW + gap);
        const h = d.value === 0 ? 0 : Math.round((d.value / max) * chartH);
        const y = pad.t + chartH - h;

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barW);
        rect.setAttribute('height', h);
        rect.setAttribute('rx', 6);
        rect.setAttribute('fill', d.color);
        rect.setAttribute('opacity', '0.9');
        svg.appendChild(rect);

        // Value label
        const val = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        val.setAttribute('x', x + barW/2);
        val.setAttribute('y', y - 6);
        val.setAttribute('text-anchor', 'middle');
        val.setAttribute('font-size', '12');
        val.setAttribute('fill', '#111827');
        val.textContent = d.value;
        svg.appendChild(val);

        // Category label
        const lab = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        lab.setAttribute('x', x + barW/2);
        lab.setAttribute('y', pad.t + chartH + 18);
        lab.setAttribute('text-anchor', 'middle');
        lab.setAttribute('font-size', '12');
        lab.setAttribute('fill', '#374151');
        lab.textContent = d.label;
        svg.appendChild(lab);
    });
}

// Afficher les derni√®res conversions de l'utilisateur
function displayUserRecentConversions(conversions) {
    const container = document.getElementById('userRecentList');
    if (!container) return;

    if (!conversions || conversions.length === 0) {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-style: italic;">Aucune conversion r√©cente</div>';
        return;
    }

    const items = conversions.map(conv => {
        const date = new Date(conv.conversionDate).toLocaleString('fr-FR');
        const statusClass = conv.status === 'SUCCESS' ? 'ok' : 'warn';
        const statusIcon = conv.status === 'SUCCESS' ? '‚úì' : '‚úï';

        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 6px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <div>
                    <div style="font-weight: 500; font-size: 14px;">${conv.inputFormat || 'pain.001'} ‚Üí ${conv.outputFormat || 'MT101'}</div>
                    <div style="font-size: 12px; color: #666;">${date}</div>
                </div>
                <span class="chip ${statusClass}" style="font-size: 12px;">${statusIcon} ${conv.status}</span>
            </div>
        `;
    }).join('');

    container.innerHTML = items;
}

// Mettre √† jour les badges utilisateur
function updateUserBadges(stats) {
    const container = document.getElementById('userStatsBadges');
    if (!container) return;

    const successRate = stats.successRate || 0;
    let badgeColor = '#dc2626'; // Rouge par d√©faut
    let badgeText = 'D√©butant';

    if (successRate >= 95) {
        badgeColor = '#059669';
        badgeText = 'Expert';
    } else if (successRate >= 80) {
        badgeColor = '#0891b2';
        badgeText = 'Avanc√©';
    } else if (successRate >= 60) {
        badgeColor = '#ea580c';
        badgeText = 'Interm√©diaire';
    }

    const totalBadge = stats.totalConversions >= 100 ?
        '<span style="background: #7c3aed; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">üíØ Centurion</span>' : '';

    container.innerHTML = `
        <span style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
            ${badgeText} (${Math.round(successRate)}%)
        </span>
        ${totalBadge}
    `;
}

// Charger les statistiques utilisateur par date
async function loadUserStatsByDate(username, date) {
    if (!username || username === 'global') return;

    try {
        const response = await fetch(`/api/admin/users/${encodeURIComponent(username)}/stats-by-date?date=${date}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const stats = await response.json();

        // Mettre √† jour temporairement les m√©triques avec les donn√©es du jour
        const tempStats = {
            username: username,
            totalConversions: stats.total || 0,
            successfulConversions: stats.valid || 0,
            failedConversions: stats.error || 0,
            successRate: stats.total > 0 ? (stats.valid / stats.total * 100) : 0,
            recentConversions: []
        };

        updateUserMetrics(tempStats);
        renderUserChart(tempStats);

        // Afficher la date dans le titre
        const selectedUserTitle = document.getElementById('selectedUserTitle');
        selectedUserTitle.textContent = `üë§ ${username} - ${date}`;

    } catch (error) {
        console.error('Erreur lors du chargement des statistiques par date:', error);
    }
}

// Actualiser les statistiques utilisateur
function refreshUserStats() {
    if (currentSelectedUser) {
        loadUserStats(currentSelectedUser);
        pushMessage('info', 'Statistiques utilisateur actualis√©es');
    } else {
        pushMessage('warn', 'Aucun utilisateur s√©lectionn√©');
    }
}

// Modifier la fonction de chargement des stats par date pour prendre en compte l'utilisateur s√©lectionn√©
const originalLoadStatsForDate = loadStatsForDate;
loadStatsForDate = async function(dateStr) {
    userStatsDate = dateStr;
    await originalLoadStatsForDate(dateStr);

    // Si un utilisateur est s√©lectionn√©, charger aussi ses stats pour cette date
    if (currentSelectedUser && currentSelectedUser !== 'global') {
        await loadUserStatsByDate(currentSelectedUser, dateStr);
    }
};
</script>
</body>
</html>

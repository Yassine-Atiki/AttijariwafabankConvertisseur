<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Convertisseur MX/MT - Attijariwafa bank</title>
    <link rel="stylesheet" href="/css/dashboard.css" />
    <style>
        /* CSS inline pour s'assurer que les vues fonctionnent */
        .view {
            display: none;
        }
        .view.is-visible {
            display: block;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <aside class="sidebar" role="navigation" aria-label="Menu principal">
        <div class="sidebar-header">
            <img class="sidebar-logo" src="/images/attijari_logo.png" alt="Logo Attijariwafa bank" />
            <div class="brand-text">
                <span class="bank">Attijariwafa bank</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a id="nav-home" class="nav-item active" href="javascript:void(0)" onclick="showSection('view-home')" title="Accueil">
                <span class="icon" aria-hidden="true">üè†</span>
                <span class="label">Accueil</span>
            </a>
            <a id="nav-convert" class="nav-item" href="javascript:void(0)" onclick="showSection('view-convert')" title="Convertir">
                <span class="icon" aria-hidden="true">üîÑ</span>
                <span class="label">pain.001 ‚Üí MT101</span>
            </a>
            <a id="nav-transform" class="nav-item" href="javascript:void(0)" onclick="showSection('view-transform')" title="Historique">
                <span class="icon" aria-hidden="true">üìã</span>
                <span class="label">Historique</span>
            </a>
            <a id="nav-reports" class="nav-item" href="javascript:void(0)" onclick="showSection('view-reports')" title="Rapports">
                <span class="icon" aria-hidden="true">üìä</span>
                <span class="label">Rapports Erreurs</span>
            </a>
            <a id="nav-logout" class="nav-item logout-link" href="javascript:void(0)" onclick="logout()" title="D√©connexion">
                <span class="icon" aria-hidden="true">üö™</span>
                <span class="label">D√©connexion</span>
            </a>
        </nav>
    </aside>

    <div class="content">
        <section id="view-home" class="view is-visible welcome" aria-label="Accueil">
            <div class="home-grid">
                <div class="home-main">
                    <div class="panel">
                        <div class="welcome-row">
                            <div>
                                <strong>Bienvenue dans le Convertisseur MX ‚Üí MT</strong>
                                <div class="muted">yassineatiki@attijariwafa.com</div>
                            </div>
                            <button class="btn btn-primary" type="button" onclick="showSection('view-convert')">Nouvelle transformation</button>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric-cards">
                            <div class="metric-card">
                                <div class="ring total" style="--v:.94"><div class="center">Œ£</div></div>
                                <div>
                                    <div class="metric-title">Total Messages</div>
                                    <div class="metric-value" th:text="${totalConversions}">0</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="ring success" style="--v:.96"><div class="center">‚úì</div></div>
                                <div>
                                    <div class="metric-title">Messages Valides</div>
                                    <div class="metric-value" th:text="${validConversions}">0</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="ring error" style="--v:.04"><div class="center">!</div></div>
                                <div>
                                    <div class="metric-title">Messages en Erreur</div>
                                    <div class="metric-value" th:text="${invalidConversions}">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-convert" class="view" aria-label="Conversion pain.001 vers MT101">
            <div class="container">
                <h1>üîÑ Convertisseur MX PAIN 001 ‚Üí MT 101</h1>

                <div class="panel">
                    <h2>Param√®tres de Conversion</h2>
                    <p>Type source : MX PAIN 001 v3 (ISO 20022)</p>
                    <p>Type cible : MT 101 (SWIFT FIN)</p>
                </div>

                <div class="panel">
                    <h2>Zone de Conversion</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>Entr√©e MX PAIN 001</h3>
                            <textarea id="mx-input" rows="15" style="width: 100%; font-family: monospace;"
                                      placeholder="Collez votre message MX PAIN 001 ici..."></textarea>
                            <div style="margin-top: 10px;">
                                <input type="file" id="file-input" accept=".xml" onchange="loadFile(this)">
                                <button onclick="convertMX()" style="margin-left: 10px;">üîÑ Convertir</button>
                                <button onclick="clearAll()" style="margin-left: 10px;">üóëÔ∏è Vider</button>
                            </div>
                        </div>
                        <div>
                            <h3>Sortie MT 101</h3>
                            <textarea id="mt-output" rows="15" style="width: 100%; font-family: monospace;"
                                      placeholder="Le message MT 101 appara√Ætra ici..." readonly></textarea>
                            <div style="margin-top: 10px;">
                                <button onclick="copyMT()">üìã Copier</button>
                                <button onclick="downloadMT()" style="margin-left: 10px;">üíæ T√©l√©charger</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Statut de Validation</h3>
                    <div id="validation-status">
                        <p>‚ÑπÔ∏è Pr√™t pour la conversion</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-transform" class="view" aria-label="Historique des Conversions">
            <div class="container">
                <h1>üìã Historique des Conversions</h1>
                <div class="panel">
                    <h2>Conversions MX vers MT101</h2>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Format</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Statut</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="history : ${conversionHistory}">
                                <td style="padding: 10px; border: 1px solid #ddd;" th:text="${#temporals.format(history.conversionDate, 'dd/MM/yyyy HH:mm')}">-</td>
                                <td style="padding: 10px; border: 1px solid #ddd;" th:text="${history.inputFormat + ' ‚Üí ' + history.outputFormat}">-</td>
                                <td style="padding: 10px; border: 1px solid #ddd;" th:text="${history.status}">-</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <button onclick="viewDetails()">D√©tails</button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(conversionHistory)}">
                                <td colspan="4" style="padding: 20px; text-align: center; font-style: italic;">
                                    Aucun historique disponible
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-reports" class="view" aria-label="Rapports et Logs">
            <div class="container">
                <h1>üìä Rapports & Logs</h1>
                <div class="panel">
                    <h2>Logs d'Application</h2>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto;">
                        <div>2025-08-13 10:30:00 INFO  - Application d√©marr√©e</div>
                        <div>2025-08-13 10:30:15 INFO  - Validation XSD initialis√©e</div>
                        <div>2025-08-13 10:30:30 INFO  - Service de conversion MT101 activ√©</div>
                        <div>2025-08-13 10:30:45 INFO  - MongoDB connect√© : mx_mt_converter_db</div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
// Navigation entre les sections
function showSection(sectionId) {
    console.log('Navigation vers: ' + sectionId);

    // Masquer toutes les vues
    const views = document.querySelectorAll('.view');
    views.forEach(view => {
        view.classList.remove('is-visible');
    });

    // D√©sactiver tous les √©l√©ments de navigation
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });

    // Afficher la section demand√©e
    const targetView = document.getElementById(sectionId);
    if (targetView) {
        targetView.classList.add('is-visible');
    }

    // Activer l'√©l√©ment de navigation correspondant
    const navId = sectionId.replace('view-', 'nav-');
    const activeNav = document.getElementById(navId);
    if (activeNav) {
        activeNav.classList.add('active');
    }
}

// Fonction de d√©connexion
function logout() {
    if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        window.location.href = '/logout';
    }
}

// Charger un fichier
function loadFile(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('mx-input').value = e.target.result;
            updateValidationStatus('üìÑ Fichier charg√©: ' + file.name);
        };
        reader.readAsText(file);
    }
}

// Conversion MX vers MT101
async function convertMX() {
    const mxContent = document.getElementById('mx-input').value;
    const outputArea = document.getElementById('mt-output');

    if (!mxContent.trim()) {
        updateValidationStatus('‚ùå Veuillez entrer un message MX PAIN 001');
        return;
    }

    updateValidationStatus('üîÑ Conversion en cours...');

    try {
        const response = await fetch('/api/conversion/convert/text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/xml; charset=utf-8'
            },
            body: mxContent
        });

        const result = await response.json();

        if (result.success) {
            outputArea.value = result.mtMessage;
            updateValidationStatus('‚úÖ Conversion MT101 r√©ussie', result.validationErrors);
        } else {
            outputArea.value = '';
            updateValidationStatus('‚ùå Erreur: ' + result.errorMessage, result.validationErrors);
        }

    } catch (error) {
        console.error('Erreur de conversion:', error);
        updateValidationStatus('‚ùå Erreur de communication: ' + error.message);
        outputArea.value = '';
    }
}

// Mettre √† jour le statut de validation
function updateValidationStatus(message, validationErrors = null) {
    const statusDiv = document.getElementById('validation-status');
    let html = '<p>' + message + '</p>';

    if (validationErrors && validationErrors.length > 0) {
        html += '<div style="margin-top: 10px;"><strong>D√©tails de validation:</strong><ul>';
        validationErrors.forEach(error => {
            html += '<li style="color: #d32f2f;">' + error + '</li>';
        });
        html += '</ul></div>';
    }

    statusDiv.innerHTML = html;
}

// Vider les zones de texte
function clearAll() {
    document.getElementById('mx-input').value = '';
    document.getElementById('mt-output').value = '';
    document.getElementById('file-input').value = '';
    updateValidationStatus('‚ÑπÔ∏è Pr√™t pour la conversion');
}

// Copier le message MT101
function copyMT() {
    const mtOutput = document.getElementById('mt-output');
    if (mtOutput.value.trim()) {
        mtOutput.select();
        document.execCommand('copy');
        updateValidationStatus('üìã Message MT101 copi√© dans le presse-papier');
    } else {
        updateValidationStatus('‚ùå Aucun message MT101 √† copier');
    }
}

// T√©l√©charger le message MT101
function downloadMT() {
    const mtOutput = document.getElementById('mt-output');
    if (mtOutput.value.trim()) {
        const blob = new Blob([mtOutput.value], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'message_MT101_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        updateValidationStatus('üíæ Message MT101 t√©l√©charg√©');
    } else {
        updateValidationStatus('‚ùå Aucun message MT101 √† t√©l√©charger');
    }
}

// Afficher les d√©tails d'un historique
function viewDetails() {
    alert('Fonctionnalit√© en d√©veloppement');
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard initialis√©');
    updateValidationStatus('‚ÑπÔ∏è Pr√™t pour la conversion');

    // S'assurer que la section d'accueil est affich√©e par d√©faut
    showSection('view-home');
});
</script>
</body>
</html>
